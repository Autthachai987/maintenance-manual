<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JLG Technical Publications</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&family=Kanit:wght@400;600;700;800;900&family=Oswald:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--o:#F26522;--ol:#FF7D3B;--od:#D4520F;--bk:#FAFAFA;--wh:#FFFFFF;--g1:#F0F0F0;--g2:#E5E5E5;--g3:#CCC;--g4:#999;--g5:#666;--g6:#333;--dk:#1A1A1A;--ok:#4CAF50;--dg:#E53935;--inf:#1976D2;--og:rgba(242,101,34,0.08);--shadow:0 2px 12px rgba(0,0,0,0.08);--shadow2:0 4px 24px rgba(0,0,0,0.12)}
body{font-family:'Sarabun',sans-serif;background:var(--bk);color:var(--g6);min-height:100vh}

/* LOGIN */
.login-ov{position:fixed;inset:0;background:var(--dk);z-index:9999;display:flex;align-items:center;justify-content:center}
.login-ov.hid{display:none}
.login-split{display:flex;width:90%;max-width:900px;border-radius:16px;overflow:hidden;box-shadow:var(--shadow2)}
.login-left{flex:1;background:linear-gradient(135deg,var(--o) 0%,#E8520D 100%);padding:48px 40px;display:flex;flex-direction:column;justify-content:center;color:#fff}
.login-left h1{font-family:'Oswald',sans-serif;font-size:42px;font-weight:700;text-transform:uppercase;line-height:1.1;margin-bottom:12px}
.login-left p{font-size:15px;opacity:.85;line-height:1.6}
.login-left .ll-badge{margin-top:32px;display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,0.15);padding:10px 18px;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;backdrop-filter:blur(4px)}
.login-right{flex:1;background:var(--wh);padding:48px 40px;display:flex;flex-direction:column;justify-content:center}
.login-right h2{font-family:'Kanit',sans-serif;font-size:22px;font-weight:800;color:var(--g6);margin-bottom:6px}
.login-right .lsub{font-size:13px;color:var(--g4);margin-bottom:28px}
.lfg{margin-bottom:18px}
.lfg label{display:block;font-size:12px;font-weight:700;color:var(--g5);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}
.lfg input{width:100%;padding:12px 14px;background:var(--g1);border:2px solid transparent;border-radius:8px;font-size:15px;color:var(--g6);outline:none;font-family:'Sarabun',sans-serif;transition:border-color .2s}
.lfg input:focus{border-color:var(--o);background:var(--wh)}
.lerr{color:var(--dg);font-size:13px;font-weight:700;margin-bottom:10px;min-height:18px}
.lrem{display:flex;align-items:center;gap:8px;margin-bottom:18px}
.lrem input{accent-color:var(--o);width:16px;height:16px}
.lrem label{font-size:13px;color:var(--g5);cursor:pointer}
.lbtn{width:100%;padding:14px;background:var(--o);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Sarabun',sans-serif;transition:all .2s;text-transform:uppercase;letter-spacing:1px}
.lbtn:hover{background:var(--od);transform:translateY(-1px);box-shadow:0 4px 16px rgba(242,101,34,0.3)}

/* APP */
.app{display:none}.app.show{display:block}

/* HEADER - JLG Style */
.hdr{background:var(--wh);border-bottom:3px solid var(--o);box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
.hdr-m{display:flex;align-items:center;justify-content:space-between;padding:0 28px;max-width:1400px;margin:0 auto;height:64px}
.hdr-logo{display:flex;align-items:center;gap:14px}
.hdr-logo-box{width:48px;height:48px;background:var(--o);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:22px;color:#fff;letter-spacing:1px}
.hdr-logo h1{font-family:'Oswald',sans-serif;font-size:16px;font-weight:700;color:var(--g6);text-transform:uppercase;line-height:1.2}
.hdr-logo h1 span{color:var(--o)}
.hdr-logo small{font-family:'Sarabun',sans-serif;font-size:10px;color:var(--g4);font-weight:400;text-transform:uppercase;letter-spacing:2px;display:block}
.hdr-nav{display:flex;align-items:center;gap:16px}
.hdr-user{display:flex;align-items:center;gap:10px;padding:6px 14px;background:var(--g1);border-radius:24px}
.hdr-user .av{width:30px;height:30px;background:var(--o);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff}
.hdr-user .nm{font-size:13px;font-weight:700;color:var(--g6)}.hdr-user .rl{font-size:10px;color:var(--g4)}
.btn{padding:10px 18px;border:none;border-radius:6px;font-family:'Sarabun',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.bo{background:var(--o);color:#fff}.bo:hover{background:var(--od);box-shadow:0 2px 8px rgba(242,101,34,0.25)}
.bg{background:var(--g1);color:var(--g5);border:1px solid var(--g2)}.bg:hover{border-color:var(--o);color:var(--o)}
.bw{background:var(--wh);color:var(--g5);border:1px solid var(--g2)}.bw:hover{border-color:var(--g3)}
.bsm{padding:7px 14px;font-size:12px}

/* EXPLORER */
.ex{max-width:1400px;margin:0 auto;padding:24px 28px}
.gas-bar{background:var(--wh);border:1px solid var(--g2);border-radius:10px;padding:12px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;box-shadow:var(--shadow)}
.gas-bar label{font-size:12px;font-weight:800;color:var(--o);text-transform:uppercase;letter-spacing:1px;white-space:nowrap}
.gas-bar input{flex:1;min-width:200px;padding:8px 12px;background:var(--g1);border:1px solid var(--g2);border-radius:6px;font-size:12px;color:var(--g6);outline:none;font-family:monospace}
.gas-bar input:focus{border-color:var(--o)}

/* TOOLBAR */
.tbar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.bcr{display:flex;align-items:center;gap:4px;flex:1;font-size:14px;flex-wrap:wrap}
.bcr a{color:var(--o);font-weight:600;cursor:pointer;text-decoration:none}.bcr a:hover{text-decoration:underline}
.bcr .sep{color:var(--g3);font-size:16px}
.bcr .cur{color:var(--g6);font-weight:800;font-family:'Kanit',sans-serif}
.search-box{position:relative}
.search-box input{padding:10px 14px 10px 38px;border:2px solid var(--g2);border-radius:8px;font-size:14px;width:280px;outline:none;background:var(--wh);font-family:'Sarabun',sans-serif;color:var(--g6);transition:border-color .2s}
.search-box input:focus{border-color:var(--o)}
.search-box input::placeholder{color:var(--g3)}
.search-box .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--g3);font-size:16px}

/* FILE GRID */
.fgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.fcard{background:var(--wh);border:2px solid transparent;border-radius:12px;padding:20px 14px;text-align:center;cursor:pointer;transition:all .15s;position:relative;box-shadow:var(--shadow)}
.fcard:hover{border-color:var(--o);transform:translateY(-3px);box-shadow:var(--shadow2)}
.fcard .fic{font-size:48px;margin-bottom:10px;display:block}
.fcard .fnm{font-size:12px;font-weight:700;color:var(--g6);word-break:break-all;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:32px}
.fcard .fmeta{font-size:10px;color:var(--g4);margin-top:6px}
.fcard .fdel{position:absolute;top:8px;right:8px;width:24px;height:24px;border-radius:50%;background:var(--dg);color:#fff;border:none;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
.fcard:hover .fdel{display:flex}
.fcard .folder-badge{position:absolute;top:8px;left:8px;background:var(--og);color:var(--o);font-size:9px;font-weight:800;padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.5px}
/* Open PDF button on hover */
.fcard .fopen{display:none;position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:var(--o);color:#fff;border:none;border-radius:6px;padding:6px 16px;font-size:11px;font-weight:800;cursor:pointer;font-family:'Sarabun',sans-serif;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 2px 8px rgba(242,101,34,0.3);white-space:nowrap}
.fcard:hover .fopen{display:block}

/* LOADING */
.ld{text-align:center;padding:80px;color:var(--g4)}
.ld .sp{display:inline-block;width:36px;height:36px;border:3px solid var(--g2);border-top-color:var(--o);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}
.emp{text-align:center;padding:80px;color:var(--g4)}.emp .ei{font-size:64px;opacity:.3;margin-bottom:14px}

/* VIEWER */
.pvw{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:250;align-items:center;justify-content:center;backdrop-filter:blur(4px)}.pvw.open{display:flex}
.pvw-box{width:95%;max-width:1100px;height:92vh;background:var(--wh);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow2)}
.pvw-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:2px solid var(--g2);background:var(--g1)}
.pvw-hd h3{font-family:'Kanit',sans-serif;font-size:15px;color:var(--g6);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pvw-bd{flex:1;background:#525659}.pvw-bd iframe{width:100%;height:100%;border:none}

.tst{position:fixed;bottom:24px;right:24px;padding:14px 24px;border-radius:8px;font-weight:700;z-index:300;transform:translateY(80px);opacity:0;transition:all .3s;font-size:14px;box-shadow:var(--shadow2)}.tst.show{transform:translateY(0);opacity:1}.tst.ok{background:var(--ok);color:#fff}.tst.err{background:var(--dg);color:#fff}

@media(max-width:768px){
  .login-split{flex-direction:column}.login-left{padding:28px 24px}.login-left h1{font-size:28px}.login-right{padding:28px 24px}
  .fgrid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
  .hdr-nav .bl{display:none}.hdr-user .nm,.hdr-user .rl{display:none}
  .gas-bar{flex-direction:column;align-items:stretch}
  .search-box input{width:100%}.tbar{gap:8px}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-ov" id="LS">
<div class="login-split">
<div class="login-left">
  <h1>Technical<br>Publications</h1>
  <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ<br>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ Operation, Service, Part Manual ‡πÅ‡∏•‡∏∞ Schematic ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</p>
  <div class="ll-badge">JLG &nbsp;|&nbsp; MAINTENANCE MANUAL SYSTEM</div>
</div>
<div class="login-right">
  <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
  <div class="lsub">‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
  <div class="lfg"><label>Username</label><input id="lu" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Username" onkeydown="if(event.key==='Enter')doLogin()"></div>
  <div class="lfg"><label>Password</label><input type="password" id="lp" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Password" onkeydown="if(event.key==='Enter')doLogin()"></div>
  <div class="lrem"><input type="checkbox" id="rm"><label for="rm">‡∏à‡∏î‡∏à‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</label></div>
  <div class="lerr" id="le"></div>
  <button class="lbtn" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‚Üí</button>
</div>
</div></div>

<!-- APP -->
<div class="app" id="APP">
<header class="hdr"><div class="hdr-m">
  <div class="hdr-logo">
    <div class="hdr-logo-box">JLG</div>
    <div><h1>Technical <span>Publications</span></h1><small>Maintenance Manual System</small></div>
  </div>
  <div class="hdr-nav">
    <div class="hdr-user"><div class="av" id="uAv">A</div><div><div class="nm" id="uNm">-</div><div class="rl" id="uRl">-</div></div></div>
    <button class="btn bg bsm" onclick="doLogout()">üö™ <span class="bl">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></button>
  </div>
</div></header>

<div class="ex">
  <div id="gasArea"></div>
  <div class="tbar">
    <div class="bcr" id="bcr"></div>
    <div class="search-box"><span class="si">üîç</span><input id="sq" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå..." oninput="filterFiles()"></div>
    <button class="btn bo bsm" id="btnUp" onclick="pickFile()" style="display:none">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
    <button class="btn bg bsm" id="btnNf" onclick="newFolder()" style="display:none">üìÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
  </div>
  <div id="content"></div>
</div>
</div>

<!-- VIEWER -->
<div class="pvw" id="pvw" onclick="if(event.target===this)closePV()">
<div class="pvw-box"><div class="pvw-hd"><h3 id="pvwT">Document Preview</h3><button class="btn bg bsm" onclick="closePV()">‚úï ‡∏õ‡∏¥‡∏î</button></div><div class="pvw-bd"><iframe id="pvwF"></iframe></div></div>
</div>

<div class="tst" id="tt"></div>
<input type="file" id="fIn" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.zip,.rar" style="display:none" multiple>

<script>
var USERS=[
{username:'admin',password:'admin1234',name:'‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á',role:'admin',display:'Admin'},
{username:'tech1',password:'tech1234',name:'‡∏ä‡πà‡∏≤‡∏á 1',role:'tech',display:'Technician'},
{username:'tech2',password:'tech2234',name:'‡∏ä‡πà‡∏≤‡∏á 2',role:'tech',display:'Technician'},
{username:'tech3',password:'tech3234',name:'‡∏ä‡πà‡∏≤‡∏á 3',role:'tech',display:'Technician'},
{username:'tech4',password:'tech4234',name:'‡∏ä‡πà‡∏≤‡∏á 4',role:'tech',display:'Technician'},
{username:'tech5',password:'tech5234',name:'‡∏ä‡πà‡∏≤‡∏á 5',role:'tech',display:'Technician'},
{username:'tech6',password:'tech6234',name:'‡∏ä‡πà‡∏≤‡∏á 6',role:'tech',display:'Technician'},
{username:'tech7',password:'tech7234',name:'‡∏ä‡πà‡∏≤‡∏á 7',role:'tech',display:'Technician'},
{username:'tech8',password:'tech8234',name:'‡∏ä‡πà‡∏≤‡∏á 8',role:'tech',display:'Technician'},
{username:'tech9',password:'tech9234',name:'‡∏ä‡πà‡∏≤‡∏á 9',role:'tech',display:'Technician'},
{username:'tech10',password:'tech0234',name:'‡∏ä‡πà‡∏≤‡∏á 10',role:'tech',display:'Technician'},
{username:'tech11',password:'tech1134',name:'‡∏ä‡πà‡∏≤‡∏á 11',role:'tech',display:'Technician'},
{username:'tech12',password:'tech1234x',name:'‡∏ä‡πà‡∏≤‡∏á 12',role:'tech',display:'Technician'}
];
var curUser=null,GAS=localStorage.getItem('jlg_gas')||'';
var ROOT_ID='1NfXyo_lAhLKztNQDiKijhAuSdSiK_1z6';
var navStack=[{id:ROOT_ID,name:'Home'}];
var cachedData=null;

function doLogin(){
  var u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value,f=null;
  for(var i=0;i<USERS.length;i++){if(USERS[i].username===u&&USERS[i].password===p){f=USERS[i];break;}}
  if(!f){document.getElementById('le').textContent='‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';return;}
  curUser=f;
  if(document.getElementById('rm').checked)localStorage.setItem('jlg_ses',JSON.stringify({username:f.username}));
  showApp();
}
function doLogout(){curUser=null;localStorage.removeItem('jlg_ses');document.getElementById('APP').classList.remove('show');document.getElementById('LS').classList.remove('hid');document.getElementById('lu').value='';document.getElementById('lp').value='';document.getElementById('le').textContent='';}
function checkSession(){var s=localStorage.getItem('jlg_ses');if(s){try{var d=JSON.parse(s);for(var i=0;i<USERS.length;i++){if(USERS[i].username===d.username){curUser=USERS[i];showApp();return;}}}catch(e){}}}

function showApp(){
  document.getElementById('LS').classList.add('hid');
  document.getElementById('APP').classList.add('show');
  document.getElementById('uNm').textContent=curUser.name;
  document.getElementById('uRl').textContent=curUser.display;
  document.getElementById('uAv').textContent=curUser.name.charAt(0);
  var isAdm=curUser.role==='admin';
  document.getElementById('btnUp').style.display=isAdm?'inline-flex':'none';
  document.getElementById('btnNf').style.display=isAdm?'inline-flex':'none';
  if(isAdm){document.getElementById('gasArea').innerHTML='<div class="gas-bar"><label>‚öôÔ∏è API URL</label><input id="gasInp" value="'+GAS+'" placeholder="‡∏ß‡∏≤‡∏á Google Apps Script Web App URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (https://script.google.com/macros/s/.../exec)"><button class="btn bo bsm" onclick="saveGas()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>';}
  else{document.getElementById('gasArea').innerHTML='';}
  navStack=[{id:ROOT_ID,name:'Home'}];
  loadFolder(ROOT_ID);
}
function saveGas(){GAS=document.getElementById('gasInp').value.trim();localStorage.setItem('jlg_gas',GAS);toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API URL ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');}

function loadFolder(fid){
  if(!GAS){document.getElementById('content').innerHTML='<div class="emp"><div class="ei">‚öôÔ∏è</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô</p><p style="font-size:12px;margin-top:6px;color:var(--g3)">Admin: ‡∏ß‡∏≤‡∏á URL ‡∏à‡∏≤‡∏Å Google Apps Script ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p></div>';renderBcr();return;}
  document.getElementById('content').innerHTML='<div class="ld"><div class="sp"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
  renderBcr();
  fetch(GAS,{method:'POST',body:JSON.stringify({action:'list',folderId:fid}),redirect:'follow'})
  .then(function(r){return r.json();})
  .then(function(res){if(res.success){cachedData=res.data;renderExplorer(res.data);}else{document.getElementById('content').innerHTML='<div class="emp"><div class="ei">‚ùå</div><p>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p></div>';}})
  .catch(function(){document.getElementById('content').innerHTML='<div class="emp"><div class="ei">üîå</div><p>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p><p style="font-size:12px;margin-top:6px;color:var(--g3)">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô https://script.google.com/macros/s/.../exec</p></div>';});
}

function renderBcr(){
  var bc=document.getElementById('bcr'),h='';
  for(var i=0;i<navStack.length;i++){
    if(i>0)h+='<span class="sep">¬ª</span>';
    if(i<navStack.length-1)h+='<a onclick="goBack('+i+')">'+navStack[i].name+'</a>';
    else h+='<span class="cur">'+navStack[i].name+'</span>';
  }
  bc.innerHTML=h;
}
function goBack(i){navStack=navStack.slice(0,i+1);loadFolder(navStack[i].id);}
function openFolder(id,name){navStack.push({id:id,name:name});loadFolder(id);}

function renderExplorer(data){
  var c=document.getElementById('content'),isAdm=curUser&&curUser.role==='admin',sq=document.getElementById('sq').value.toLowerCase();
  var folders=data.folders,files=data.files;
  if(sq){
    folders=folders.filter(function(f){return f.name.toLowerCase().indexOf(sq)>=0;});
    files=files.filter(function(f){return f.name.toLowerCase().indexOf(sq)>=0;});
  }
  if(!folders.length&&!files.length){c.innerHTML='<div class="emp"><div class="ei">üì≠</div><p>'+(!sq?'‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡∏á':'‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤')+'</p></div>';return;}
  var h='<div class="fgrid">';
  folders.forEach(function(f){
    h+='<div class="fcard" onclick="openFolder(\''+f.id+'\',\''+esc(f.name)+'\')"><span class="folder-badge">FOLDER</span><span class="fic">üìÅ</span><div class="fnm">'+f.name+'</div><div class="fmeta">‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</div></div>';
  });
  files.forEach(function(f){
    var icon=fIcon(f.ext,f.mimeType),sz=fSize(f.size);
    h+='<div class="fcard" onclick="openFile(\''+f.id+'\',\''+esc(f.name)+'\',\''+f.viewUrl+'\',\''+f.ext+'\')">';
    if(isAdm)h+='<button class="fdel" onclick="event.stopPropagation();delFile(\''+f.id+'\')">‚úï</button>';
    h+='<span class="fic">'+icon+'</span><div class="fnm">'+f.name+'</div><div class="fmeta">'+sz+' ¬∑ '+f.date+'</div>';
    h+='<button class="fopen" onclick="event.stopPropagation();openFile(\''+f.id+'\',\''+esc(f.name)+'\',\''+f.viewUrl+'\',\''+f.ext+'\')">OPEN FILE</button>';
    h+='</div>';
  });
  h+='</div>';c.innerHTML=h;
}
function filterFiles(){if(cachedData)renderExplorer(cachedData);}
function esc(s){return s.replace(/'/g,'').replace(/"/g,'');}
function fIcon(ext,mime){
  if(ext==='pdf')return 'üìï';if(ext==='doc'||ext==='docx')return 'üìò';if(ext==='xls'||ext==='xlsx')return 'üìó';
  if(ext==='ppt'||ext==='pptx')return 'üìô';if(ext==='jpg'||ext==='jpeg'||ext==='png'||ext==='gif'||ext==='webp')return 'üñºÔ∏è';
  if(ext==='zip'||ext==='rar'||ext==='7z')return 'üì¶';if(ext==='mp4')return 'üé¨';return 'üìÑ';
}
function fSize(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}

function openFile(id,name,viewUrl,ext){
  if(ext==='pdf'||ext==='jpg'||ext==='jpeg'||ext==='png'||ext==='gif'){
    document.getElementById('pvwT').textContent=name;
    document.getElementById('pvwF').src=viewUrl;
    document.getElementById('pvw').classList.add('open');
  }else{window.open(viewUrl,'_blank');}
}
function closePV(){document.getElementById('pvw').classList.remove('open');document.getElementById('pvwF').src='';}

function pickFile(){
  if(!GAS){toast('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô','err');return;}
  var inp=document.getElementById('fIn');
  inp.onchange=function(ev){
    var files=ev.target.files;if(!files.length)return;
    var curFid=navStack[navStack.length-1].id;
    var uploaded=0,total=files.length;
    toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î '+total+' ‡πÑ‡∏ü‡∏•‡πå...');
    for(var i=0;i<files.length;i++){(function(file){
      var reader=new FileReader();
      reader.onload=function(e){
        var b64=e.target.result.split(',')[1];
        fetch(GAS,{method:'POST',redirect:'follow',body:JSON.stringify({action:'upload',folderId:curFid,fileName:file.name,mimeType:file.type||'application/octet-stream',fileBase64:b64})})
        .then(function(r){return r.json();})
        .then(function(d){uploaded++;if(uploaded>=total){toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î '+total+' ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');loadFolder(curFid);}})
        .catch(function(){uploaded++;if(uploaded>=total)loadFolder(curFid);});
      };reader.readAsDataURL(file);
    })(files[i]);}
    inp.value='';
  };inp.click();
}
function newFolder(){
  if(!GAS){toast('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô','err');return;}
  var name=prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà:');if(!name||!name.trim())return;
  var curFid=navStack[navStack.length-1].id;
  toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
  fetch(GAS,{method:'POST',redirect:'follow',body:JSON.stringify({action:'createFolder',folderId:curFid,folderName:name.trim()})})
  .then(function(r){return r.json();}).then(function(d){if(d.success){toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');loadFolder(curFid);}}).catch(function(){toast('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','err');});
}
function delFile(fid){
  if(!confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ?'))return;
  var curFid=navStack[navStack.length-1].id;
  fetch(GAS,{method:'POST',redirect:'follow',body:JSON.stringify({action:'delete',fileId:fid})})
  .then(function(r){return r.json();}).then(function(){toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');loadFolder(curFid);}).catch(function(){toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err');});
}
function toast(m,t){var e=document.getElementById('tt');e.textContent=m;e.className='tst '+(t||'ok')+' show';setTimeout(function(){e.classList.remove('show');},3000);}

checkSession();
</script>
</body>
</html>
