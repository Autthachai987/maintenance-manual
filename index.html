<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JLG Maintenance Manual System</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&family=Kanit:wght@400;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{--o:#F26522;--ol:#FF8243;--od:#D4520F;--og:rgba(242,101,34,0.25);--bk:#1A1A1A;--dk:#222;--gd:#2D2D2D;--gm:#3A3A3A;--gl:#888;--tx:#E8E8E8;--td:#AAA;--bd:#3A3A3A;--ok:#4CAF50;--dg:#E53935;--inf:#42A5F5;--wn:#FFA726}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Sarabun',sans-serif;background:var(--bk);color:var(--tx);min-height:100vh;line-height:1.6}
.login-ov{position:fixed;inset:0;background:var(--bk);z-index:9999;display:flex;align-items:center;justify-content:center}
.login-ov.hid{display:none}
.lbox{background:var(--dk);border:1px solid var(--bd);border-radius:16px;padding:40px;width:90%;max-width:420px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.llogo{width:80px;height:80px;background:var(--o);border-radius:16px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:32px;color:#fff;margin:0 auto 20px;box-shadow:0 4px 30px rgba(242,101,34,0.4);position:relative;overflow:hidden}
.llogo::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 40%,rgba(255,255,255,0.15) 50%,transparent 60%);animation:sh 3s infinite}
@keyframes sh{0%{transform:translateX(-100%) rotate(45deg)}100%{transform:translateX(100%) rotate(45deg)}}
.lbox h2{font-family:'Kanit',sans-serif;font-size:22px;font-weight:800;color:#fff}.lbox h2 span{color:var(--o)}
.lbox .sub{font-size:12px;color:var(--o);font-family:'Bebas Neue',sans-serif;letter-spacing:3px;margin-bottom:28px}
.lfg{margin-bottom:16px;text-align:left}.lfg label{display:block;font-size:13px;font-weight:700;color:var(--td);margin-bottom:5px}
.lfg input{width:100%;padding:12px;background:var(--gd);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-size:15px;outline:none;font-family:'Sarabun',sans-serif}
.lfg input:focus{border-color:var(--o);box-shadow:0 0 0 3px var(--og)}
.lerr{color:var(--dg);font-size:13px;font-weight:700;margin-bottom:12px;min-height:20px}
.lbtn{width:100%;padding:14px;background:var(--o);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:800;cursor:pointer;font-family:'Sarabun',sans-serif}.lbtn:hover{background:var(--ol)}
.lrem{display:flex;align-items:center;gap:8px;margin-bottom:16px}.lrem input{accent-color:var(--o);width:16px;height:16px}.lrem label{font-size:13px;color:var(--td);cursor:pointer}
.lfooter{margin-top:20px;font-size:12px;color:var(--gl)}
.app{display:none}.app.show{display:block}
.hdr{background:linear-gradient(180deg,#2A2A2A,var(--bk));border-bottom:3px solid var(--o);position:sticky;top:0;z-index:100}
.hdr-m{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;max-width:1400px;margin:0 auto}
.la{display:flex;align-items:center;gap:14px}
.lb{width:46px;height:46px;background:var(--o);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:19px;color:#fff;box-shadow:0 4px 20px rgba(242,101,34,0.3);position:relative;overflow:hidden}
.lb::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 40%,rgba(255,255,255,0.15) 50%,transparent 60%);animation:sh 3s infinite}
.li h1{font-family:'Kanit',sans-serif;font-size:18px;font-weight:800;color:#fff}.li h1 span{color:var(--o)}
.li p{font-family:'Bebas Neue',sans-serif;font-size:11px;color:var(--o);letter-spacing:3px}
.hb{display:flex;gap:8px;align-items:center}
.uinfo{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--gd);border-radius:8px;border:1px solid var(--bd)}
.uinfo .uav{width:28px;height:28px;background:var(--o);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff}
.uinfo .un{font-size:12px;font-weight:600}.uinfo .ur{font-size:10px;color:var(--td)}
.btn{padding:9px 16px;border:none;border-radius:6px;font-family:'Sarabun',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.bo{background:var(--o);color:#fff}.bo:hover{background:var(--ol)}
.bg{background:transparent;color:var(--td);border:1px solid var(--bd)}.bg:hover{border-color:var(--o);color:var(--o)}
.bd{background:var(--dg);color:#fff}
/* File Explorer */
.explorer{max-width:1400px;margin:0 auto;padding:20px 24px}
.gas-box{background:rgba(242,101,34,0.08);border:1px solid var(--o);border-radius:10px;padding:14px;margin-bottom:20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.gas-box h4{font-family:'Kanit',sans-serif;color:var(--o);font-size:14px}
.gas-box input{flex:1;min-width:200px;padding:8px 12px;background:var(--gd);border:1px solid var(--bd);border-radius:6px;color:var(--tx);font-size:12px;outline:none;font-family:monospace}
.gas-box input:focus{border-color:var(--o)}
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.breadcrumb{display:flex;align-items:center;gap:6px;flex:1;font-size:14px;color:var(--td);flex-wrap:wrap}
.breadcrumb span{cursor:pointer;color:var(--o);font-weight:600}.breadcrumb span:hover{text-decoration:underline}
.breadcrumb .sep{color:var(--gl);cursor:default;font-weight:400}
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.file-card{background:var(--dk);border:1px solid var(--bd);border-radius:10px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .15s;position:relative}
.file-card:hover{border-color:var(--od);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.file-card .ficon{font-size:42px;margin-bottom:8px;display:block}
.file-card .fname{font-size:12px;font-weight:600;color:var(--tx);word-break:break-all;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.file-card .fmeta{font-size:10px;color:var(--gl);margin-top:4px}
.file-card .fdel{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;background:var(--dg);color:#fff;border:none;font-size:11px;cursor:pointer;display:none;align-items:center;justify-content:center}
.file-card:hover .fdel{display:flex}
.loading{text-align:center;padding:60px;color:var(--gl);font-size:16px}
.loading .spinner{display:inline-block;width:32px;height:32px;border:3px solid var(--bd);border-top-color:var(--o);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:60px;color:var(--gl)}
.empty-state .ei{font-size:56px;opacity:.4;margin-bottom:12px}
/* PDF Viewer */
.pvw{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:250;align-items:center;justify-content:center}.pvw.open{display:flex}
.pvw-box{width:95%;max-width:1000px;height:92vh;background:var(--dk);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;border:1px solid var(--bd)}
.pvw-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--bd)}
.pvw-hd h3{font-family:'Kanit',sans-serif;font-size:14px;color:var(--o);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pvw-bd{flex:1}.pvw-bd iframe{width:100%;height:100%;border:none}
.tst{position:fixed;bottom:24px;right:24px;padding:14px 24px;border-radius:8px;font-weight:700;z-index:300;transform:translateY(80px);opacity:0;transition:all .3s;font-size:14px}.tst.show{transform:translateY(0);opacity:1}.tst.ok{background:var(--ok);color:#fff}.tst.err{background:var(--dg);color:#fff}
@media(max-width:700px){.file-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}.hb .bl{display:none}.uinfo .un,.uinfo .ur{display:none}.gas-box{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-ov" id="LS">
<div class="lbox">
<div class="llogo">JLG</div>
<h2>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á <span>JLG</span></h2>
<div class="sub">MAINTENANCE MANUAL SYSTEM</div>
<div class="lfg"><label>Username</label><input id="lu" placeholder="Username" onkeydown="if(event.key==='Enter')doLogin()"></div>
<div class="lfg"><label>Password</label><input type="password" id="lp" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()"></div>
<div class="lrem"><input type="checkbox" id="rm"><label for="rm">‡∏à‡∏î‡∏à‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</label></div>
<div class="lerr" id="le"></div>
<button class="lbtn" onclick="doLogin()">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
<div class="lfooter">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á JLG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
</div></div>

<!-- APP -->
<div class="app" id="APP">
<header class="hdr"><div class="hdr-m"><div class="la"><div class="lb">JLG</div><div class="li"><h1>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á <span>JLG</span></h1><p>MAINTENANCE MANUAL SYSTEM</p></div></div><div class="hb"><div class="uinfo"><div class="uav" id="uAv">A</div><div><div class="un" id="uNm">-</div><div class="ur" id="uRl">-</div></div></div><button class="btn bg" onclick="doLogout()">üö™ <span class="bl">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></button></div></div></header>

<div class="explorer">
  <div id="gasArea"></div>
  <div class="toolbar">
    <div class="breadcrumb" id="bcr"></div>
    <button class="btn bo" id="btnUp" onclick="pickFile()" style="display:none">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
    <button class="btn bg" id="btnNf" onclick="newFolder()" style="display:none">üìÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
  </div>
  <div id="content"></div>
</div>
</div>

<!-- PDF Viewer -->
<div class="pvw" id="pvw" onclick="if(event.target===this)closePV()">
<div class="pvw-box"><div class="pvw-hd"><h3 id="pvwT">PDF</h3><button class="btn bg" onclick="closePV()">‚úï ‡∏õ‡∏¥‡∏î</button></div><div class="pvw-bd"><iframe id="pvwF"></iframe></div></div>
</div>

<div class="tst" id="tt"></div>
<input type="file" id="fIn" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.zip,.rar" style="display:none">

<script>
var USERS=[
{username:'admin',password:'admin1234',name:'‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á',role:'admin',display:'Admin'},
{username:'tech1',password:'tech1234',name:'‡∏ä‡πà‡∏≤‡∏á 1',role:'tech',display:'Technician'},
{username:'tech2',password:'tech2234',name:'‡∏ä‡πà‡∏≤‡∏á 2',role:'tech',display:'Technician'},
{username:'tech3',password:'tech3234',name:'‡∏ä‡πà‡∏≤‡∏á 3',role:'tech',display:'Technician'},
{username:'tech4',password:'tech4234',name:'‡∏ä‡πà‡∏≤‡∏á 4',role:'tech',display:'Technician'},
{username:'tech5',password:'tech5234',name:'‡∏ä‡πà‡∏≤‡∏á 5',role:'tech',display:'Technician'},
{username:'tech6',password:'tech6234',name:'‡∏ä‡πà‡∏≤‡∏á 6',role:'tech',display:'Technician'},
{username:'tech7',password:'tech7234',name:'‡∏ä‡πà‡∏≤‡∏á 7',role:'tech',display:'Technician'},
{username:'tech8',password:'tech8234',name:'‡∏ä‡πà‡∏≤‡∏á 8',role:'tech',display:'Technician'},
{username:'tech9',password:'tech9234',name:'‡∏ä‡πà‡∏≤‡∏á 9',role:'tech',display:'Technician'},
{username:'tech10',password:'tech0234',name:'‡∏ä‡πà‡∏≤‡∏á 10',role:'tech',display:'Technician'},
{username:'tech11',password:'tech1134',name:'‡∏ä‡πà‡∏≤‡∏á 11',role:'tech',display:'Technician'},
{username:'tech12',password:'tech1234x',name:'‡∏ä‡πà‡∏≤‡∏á 12',role:'tech',display:'Technician'}
];

var curUser=null;
var GAS=localStorage.getItem('jlg_gas')||'';
var ROOT_ID='1NfXyo_lAhLKztNQDiKijhAuSdSiK_1z6';
var navStack=[{id:ROOT_ID,name:'üìö ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}];

function doLogin(){
  var u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value,f=null;
  for(var i=0;i<USERS.length;i++){if(USERS[i].username===u&&USERS[i].password===p){f=USERS[i];break;}}
  if(!f){document.getElementById('le').textContent='‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';return;}
  curUser=f;
  if(document.getElementById('rm').checked)localStorage.setItem('jlg_ses',JSON.stringify({username:f.username}));
  showApp();
}
function doLogout(){curUser=null;localStorage.removeItem('jlg_ses');document.getElementById('APP').classList.remove('show');document.getElementById('LS').classList.remove('hid');document.getElementById('lu').value='';document.getElementById('lp').value='';document.getElementById('le').textContent='';}
function checkSession(){var s=localStorage.getItem('jlg_ses');if(s){try{var d=JSON.parse(s);for(var i=0;i<USERS.length;i++){if(USERS[i].username===d.username){curUser=USERS[i];showApp();return;}}}catch(e){}}}

function showApp(){
  document.getElementById('LS').classList.add('hid');
  document.getElementById('APP').classList.add('show');
  document.getElementById('uNm').textContent=curUser.name;
  document.getElementById('uRl').textContent=curUser.display;
  document.getElementById('uAv').textContent=curUser.name.charAt(0);
  var isAdm=curUser.role==='admin';
  document.getElementById('btnUp').style.display=isAdm?'inline-flex':'none';
  document.getElementById('btnNf').style.display=isAdm?'inline-flex':'none';
  if(isAdm){
    document.getElementById('gasArea').innerHTML='<div class="gas-box"><h4>‚öôÔ∏è API URL:</h4><input id="gasInp" value="'+GAS+'" placeholder="‡∏ß‡∏≤‡∏á Google Apps Script Web App URL"><button class="btn bo" onclick="saveGas()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>';
  }else{document.getElementById('gasArea').innerHTML='';}
  navStack=[{id:ROOT_ID,name:'üìö ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}];
  loadFolder(ROOT_ID);
}
function saveGas(){GAS=document.getElementById('gasInp').value.trim();localStorage.setItem('jlg_gas',GAS);toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API URL ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');}

// ===== FILE EXPLORER =====
function loadFolder(folderId){
  if(!GAS){document.getElementById('content').innerHTML='<div class="empty-state"><div class="ei">‚öôÔ∏è</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</p></div>';renderBcr();return;}
  document.getElementById('content').innerHTML='<div class="loading"><div class="spinner"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  renderBcr();
  fetch(GAS,{method:'POST',body:JSON.stringify({action:'list',folderId:folderId})})
  .then(function(r){return r.json();})
  .then(function(res){
    if(res.success){renderExplorer(res.data);}
    else{document.getElementById('content').innerHTML='<div class="empty-state"><div class="ei">‚ùå</div><p>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(res.error||'')+'</p></div>';}
  })
  .catch(function(err){document.getElementById('content').innerHTML='<div class="empty-state"><div class="ei">üîå</div><p>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ<br><small>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞ Deploy ‡πÉ‡∏´‡∏°‡πà</small></p></div>';});
}

function renderBcr(){
  var bc=document.getElementById('bcr');
  var h='';
  for(var i=0;i<navStack.length;i++){
    if(i>0)h+='<span class="sep">‚Ä∫</span> ';
    if(i<navStack.length-1){
      h+='<span onclick="goBack('+i+')">'+navStack[i].name+'</span>';
    }else{
      h+='<strong style="color:var(--tx)">'+navStack[i].name+'</strong>';
    }
  }
  bc.innerHTML=h;
}

function goBack(idx){
  navStack=navStack.slice(0,idx+1);
  loadFolder(navStack[idx].id);
}

function openFolder(id,name){
  navStack.push({id:id,name:name});
  loadFolder(id);
}

function renderExplorer(data){
  var c=document.getElementById('content');
  if(data.folders.length===0&&data.files.length===0){
    c.innerHTML='<div class="empty-state"><div class="ei">üì≠</div><p>‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡∏á</p></div>';
    return;
  }
  var isAdm=curUser&&curUser.role==='admin';
  var h='<div class="file-grid">';

  // Folders
  data.folders.forEach(function(f){
    h+='<div class="file-card" onclick="openFolder(\''+f.id+'\',\''+f.name.replace(/'/g,'')+'\')">';
    h+='<span class="ficon">üìÅ</span>';
    h+='<div class="fname">'+f.name+'</div>';
    h+='<div class="fmeta">‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</div>';
    h+='</div>';
  });

  // Files
  data.files.forEach(function(f){
    var icon=getFileIcon(f.ext,f.mimeType);
    var size=formatSize(f.size);
    h+='<div class="file-card" onclick="openFile(\''+f.id+'\',\''+f.name.replace(/'/g,'')+'\',\''+f.viewUrl+'\',\''+f.ext+'\')">';
    if(isAdm)h+='<button class="fdel" onclick="event.stopPropagation();delFile(\''+f.id+'\')">‚úï</button>';
    h+='<span class="ficon">'+icon+'</span>';
    h+='<div class="fname">'+f.name+'</div>';
    h+='<div class="fmeta">'+size+' ¬∑ '+f.date+'</div>';
    h+='</div>';
  });

  h+='</div>';
  c.innerHTML=h;
}

function getFileIcon(ext,mime){
  if(ext==='pdf')return 'üìï';
  if(ext==='doc'||ext==='docx')return 'üìò';
  if(ext==='xls'||ext==='xlsx')return 'üìó';
  if(ext==='ppt'||ext==='pptx')return 'üìô';
  if(ext==='jpg'||ext==='jpeg'||ext==='png'||ext==='gif'||ext==='webp')return 'üñºÔ∏è';
  if(ext==='zip'||ext==='rar'||ext==='7z')return 'üì¶';
  if(ext==='mp4'||ext==='avi'||ext==='mov')return 'üé¨';
  if(mime&&mime.indexOf('image')>=0)return 'üñºÔ∏è';
  return 'üìÑ';
}

function formatSize(bytes){
  if(bytes<1024)return bytes+' B';
  if(bytes<1048576)return (bytes/1024).toFixed(1)+' KB';
  return (bytes/1048576).toFixed(1)+' MB';
}

function openFile(id,name,viewUrl,ext){
  if(ext==='pdf'||ext==='jpg'||ext==='jpeg'||ext==='png'||ext==='gif'){
    document.getElementById('pvwT').textContent=name;
    document.getElementById('pvwF').src=viewUrl;
    document.getElementById('pvw').classList.add('open');
  }else{
    window.open(viewUrl,'_blank');
  }
}
function closePV(){document.getElementById('pvw').classList.remove('open');document.getElementById('pvwF').src='';}

// ===== UPLOAD =====
function pickFile(){
  if(!GAS){toast('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô','err');return;}
  var inp=document.getElementById('fIn');
  inp.onchange=function(ev){
    var file=ev.target.files[0];if(!file)return;
    if(file.size>50*1024*1024){toast('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB','err');return;}
    toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î '+file.name+'...');
    var reader=new FileReader();
    reader.onload=function(e){
      var b64=e.target.result.split(',')[1];
      var curFolderId=navStack[navStack.length-1].id;
      fetch(GAS,{method:'POST',body:JSON.stringify({action:'upload',folderId:curFolderId,fileName:file.name,mimeType:file.type||'application/octet-stream',fileBase64:b64})})
      .then(function(r){return r.json();})
      .then(function(data){
        if(data.success){toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î '+data.fileName+' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');loadFolder(curFolderId);}
        else{toast('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(data.error||''),'err');}
      })
      .catch(function(){toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','err');});
    };
    reader.readAsDataURL(file);
    inp.value='';
  };
  inp.click();
}

function newFolder(){
  if(!GAS){toast('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô','err');return;}
  var name=prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà:');
  if(!name||!name.trim())return;
  var curFolderId=navStack[navStack.length-1].id;
  toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå...');
  fetch(GAS,{method:'POST',body:JSON.stringify({action:'createFolder',folderId:curFolderId,folderName:name.trim()})})
  .then(function(r){return r.json();})
  .then(function(data){
    if(data.success){toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå '+data.folderName+' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');loadFolder(curFolderId);}
    else{toast('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','err');}
  })
  .catch(function(){toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','err');});
}

function delFile(fid){
  if(!confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ?'))return;
  var curFolderId=navStack[navStack.length-1].id;
  fetch(GAS,{method:'POST',body:JSON.stringify({action:'delete',fileId:fid})})
  .then(function(r){return r.json();})
  .then(function(data){if(data.success){toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');loadFolder(curFolderId);}})
  .catch(function(){toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err');});
}

function toast(m,t){var e=document.getElementById('tt');e.textContent=m;e.className='tst '+(t||'ok')+' show';setTimeout(function(){e.classList.remove('show');},3000);}

checkSession();
</script>
</body>
</html>
